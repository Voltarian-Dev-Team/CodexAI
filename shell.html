<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebLyne DOOM®</title>
  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/voltarian-dev-team/weblyne.doom/refs/heads/main/favicon.ico" />
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f5f5f5;
      font-family:
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        Oxygen,
        Ubuntu,
        Cantarell,
        "Open Sans",
        "Helvetica Neue",
        sans-serif;
      user-select: none;
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    .weblyne-container {
      border: 1px solid #ccc;
      background-color: white;
      outline: none;
      transition: box-shadow 0.3s ease;
    }

    .weblyne-container:focus {
      box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.3);
    }

    .weblyne-header {
      background-color: #212529;
      color: white;
      padding: 16px;
      margin: 5px;
      margin-bottom: 0;
    }

    .weblyne-header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: normal;
    }

    .weblyne-header p {
      margin: 4px 0 0;
      font-size: 22px;
      font-weight: bold;
    }

    .weblyne-canvas-container {
      margin: 5px;
      min-width: 320px;
      min-height: 200px;
      width: 360px;
      aspect-ratio: 16 / 10;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #999;
      font-size: 14px;
      resize: horizontal;
      overflow: auto;
    }

    @media (min-width: 768px) {
      .weblyne-canvas-container {
        width: 480px;
      }
    }

    .weblyne-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      pointer-events: none;
      opacity: 0.8;
      transition: opacity 0.15s ease;
    }

    .weblyne-container:focus .weblyne-canvas {
      opacity: 1;
    }

    .weblyne-footer {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 5px;
      border-top: 1px solid #ccc;
    }

    .weblyne-controls {
      display: flex;
      gap: 12px;
    }

    .weblyne-button {
      border: none;
      padding: 0 16px;
      border-radius: 4px;
      font-size: 14px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .weblyne-refresh-button {
      background-color: #e0e0e0;
      color: #444;
      cursor: pointer;
    }

    .weblyne-refresh-button:hover {
      background-color: #d0d0d0;
    }

    .weblyne-refresh-button:active {
      background-color: #c0c0c0;
    }

    .weblyne-refresh-icon {
      width: 14px;
      height: 14px;
      fill: #444;
    }

    .weblyne-back-button {
      background-color: #e0e0e0;
      color: #444;
      cursor: pointer;
    }

    .weblyne-back-button:hover {
      background-color: #d0d0d0;
    }

    .weblyne-back-button:active {
      background-color: #c0c0c0;
    }

    .weblyne-back-icon {
      width: 14px;
      height: 14px;
      fill: #444;
    }

    .weblyne-verify-button {
      position: relative;
      background-color: #f0f0f0;
      min-width: 70px;
      color: #888;
      pointer-events: none;
      cursor: default;
      padding: 0 12px 0 24px;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }

    .success-message {
      color: #000;
      display: none;
      text-align: center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    .success-message h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #212529;
    }

    .success-message a {
      color: #212529;
      text-decoration: none;
    }

    .success-message a:hover {
      text-decoration: underline;
    }

    @keyframes killFlash {
      0% {
        background-color: #212529;
      }

      100% {
        background-color: var(--end-color, #f0f0f0);
      }
    }

    @keyframes iconFlash {
      0% {
        fill: white;
      }

      100% {
        fill: var(--end-icon-color, #888888);
      }
    }

    .weblyne-verify-icon {
      width: 18px;
      height: 18px;
      position: absolute;
      left: 8px;
    }

    .weblyne-verify-button span {
      font-weight: 600;
    }

    .status-message {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      color: #888;
      font-size: 14px;
      display: none;
    }

    .status-message.focus {
      display: none;
    }

    .status-message.death {
      color: #f44;
      display: none;
    }

    .status-message.instructions {
      color: #666;
      display: none;
    }

    /* Show "Tap to play" when not focused, regardless of death state */
    .weblyne-container:not(:focus) .status-message.focus {
      display: block;
    }

    /* Show instructions when focused and not dead */
    .weblyne-container:focus .status-message.instructions {
      display: block;
    }

    /* Only show death message when focused */
    .weblyne-container:focus .status-message.death.visible {
      display: block;
    }

    /* Hide instructions when death message is visible */
    .weblyne-container:focus .status-message.death.visible~.status-message.instructions {
      display: none;
    }

    .vtd-footer {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #666;
    }

    .vtd-footer a {
      color: inherit;
      text-decoration: none;
    }

    .vtd-footer a:hover {
      text-decoration: underline;
    }

    /* Mobile controls */
    .mobile-controls {
      display: none;
      position: absolute;
      bottom: 30px;
      left: 0;
      right: 0;
      padding: 10px;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    @media (hover: none) and (pointer: coarse) {
      .weblyne-container:focus .mobile-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Hide keyboard instructions when showing touch controls */
      .weblyne-container:focus .status-message.instructions {
        display: none;
      }
    }

    .d-pad {
      display: grid;
      grid-template-columns: repeat(3, 40px);
      grid-template-rows: repeat(3, 40px);
      gap: 5px;
      pointer-events: auto;
    }

    .fire-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      pointer-events: auto;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }

    .d-pad button {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }

    .d-pad button:active,
    .fire-button:active {
      background: rgba(255, 255, 255, 0.3);
    }

    .d-pad .up {
      grid-column: 2;
      grid-row: 1;
    }

    .d-pad .left {
      grid-column: 1;
      grid-row: 2;
    }

    .d-pad .right {
      grid-column: 3;
      grid-row: 2;
    }

    .d-pad .down {
      grid-column: 2;
      grid-row: 3;
    }

    .vtd-footer .seperator {
      margin: 0 4px;
      opacity: 0.5;
    }

    .vtd-love-icon {
      width: 12px;
      height: 12px;
      fill: #c33;
      transform: translateY(2.5px);
    }
  </style>
</head>

<body>
  <footer class="vtd-footer">
    built by <a target="_blank" href="https://github.com/Voltarian-Dev-Team/">Voltarian Dev Team</a> with
    <svg class="vtd-love-icon" viewBox="-2 -4 24 24" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M3.636 7.208L10 13.572l6.364-6.364a3 3 0 1 0-4.243-4.243L10 5.086l-2.121-2.12a3 3 0 0 0-4.243 4.242zM9.293 1.55l.707.707.707-.707a5 5 0 1 1 7.071 7.071l-7.07 7.071a1 1 0 0 1-1.415 0l-7.071-7.07a5 5 0 1 1 7.07-7.071z"
        fill-rule="evenodd" />
    </svg>
  </footer>

  <div class="weblyne-container" tabindex="1">
    <div class="weblyne-header">
      <h2>Play WebLyne DOOM® and kill</h2>
      <p>at least 5 monsters</p>
    </div>

    <div class="weblyne-canvas-container">
      <div id="status">Downloading...</div>
      <progress id="progress" value="0" max="100" hidden></progress>
      <canvas class="weblyne-canvas" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
      <div class="mobile-controls">
        <div class="d-pad">
          <button class="up">↑</button>
          <button class="left">←</button>
          <button class="right">→</button>
          <button class="down">↓</button>
        </div>
        <button class="fire-button"></button>
      </div>
    </div>

    <div class="weblyne-footer">
      <div class="weblyne-controls">
        <button class="weblyne-button weblyne-refresh-button" aria-label="Go Back to Main Menu"
          id="refresh-button">
          <svg class="weblyne-refresh-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M7 12v-2l-4 3 4 3v-2h2.997A6.006 6.006 0 0 0 16 8h-2a4 4 0 0 1-3.996 4H7zM9 2H6.003A6.006 6.006 0 0 0 0 8h2a4 4 0 0 1 3.996-4H9v2l4-3-4-3v2z"
              fill-rule="evenodd" />
          </svg>
        </button>
        <button class="weblyne-button weblyne-back-button" aria-label="Refresh challenge" id="back-button">
          <svg class="weblyne-back-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M2.61422,5.42597 C2.8464,4.86546 3.39335,4.5 4.00004,4.5 L13.9999979,4.5 C18.1422,4.5 21.4999979,7.85786 21.4999979,12 C21.4999979,16.1421 18.1422,19.5 13.9999979,19.5 L5.00004,19.5 C4.17162,19.5 3.50004,18.8284 3.50004,18 C3.50004,17.1716 4.17162,16.5 5.00004,16.5 L13.9999979,16.5 C16.4853,16.5 18.4999979,14.4853 18.4999979,12 C18.4999979,9.51472 16.4853,7.5 13.9999979,7.5 L7.62136,7.5 L8.5607,8.43934 C9.14649,9.02513 9.14649,9.97487 8.5607,10.5607 C7.97492,11.1464 7.02517,11.1464 6.43938,10.5607 L2.93938,7.06066 C2.51039,6.63166 2.38205,5.98649 2.61422,5.42597 Z"
              fill-rule="evenodd" />
          </svg>
        </button>
      </div>
      <div class="status-message focus">Tap to play</div>
      <div class="status-message death">You died! Try again</div>
      <div class="status-message instructions">Use ↓ ↑ ← → space</div>
      <button class="weblyne-button weblyne-verify-button" aria-label="Verify, 0 out of 5 monsters killed"
        id="verify-button">
        <svg class="weblyne-verify-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M19 21C19 21.5523 18.5523 22 18 22H14H10H6C5.44771 22 5 21.5523 5 21V18.75C5 17.7835 4.2165 17 3.25 17C2.55964 17 2 16.4404 2 15.75V11C2 5.47715 6.47715 1 12 1C17.5228 1 22 5.47715 22 11V15.75C22 16.4404 21.4404 17 20.75 17C19.7835 17 19 17.7835 19 18.75V21ZM17 20V18.75C17 16.9358 18.2883 15.4225 20 15.075V11C20 6.58172 16.4183 3 12 3C7.58172 3 4 6.58172 4 11V15.075C5.71168 15.4225 7 16.9358 7 18.75V20H9V18C9 17.4477 9.44771 17 10 17C10.5523 17 11 17.4477 11 18V20H13V18C13 17.4477 13.4477 17 14 17C14.5523 17 15 17.4477 15 18V20H17ZM11 12.5C11 13.8807 8.63228 15 7.25248 15C5.98469 15 5.99206 14.055 6.00161 12.8306V12.8305C6.00245 12.7224 6.00331 12.6121 6.00331 12.5C6.00331 11.1193 7.12186 10 8.50166 10C9.88145 10 11 11.1193 11 12.5ZM17.9984 12.8306C17.9975 12.7224 17.9967 12.6121 17.9967 12.5C17.9967 11.1193 16.8781 10 15.4983 10C14.1185 10 13 11.1193 13 12.5C13 13.8807 15.3677 15 16.7475 15C18.0153 15 18.0079 14.055 17.9984 12.8306Z"
            fill="#888888" />
        </svg>
        <span>0/5</span>
      </button>
    </div>
  </div>

  <script>
    window.va =
      window.va ||
      function () {
        (window.vaq = window.vaq || []).push(arguments);
      };
  </script>
  <script>

    // Handle taps outside the canvas container
    document.addEventListener("touchstart", (e) => {
      const canvasContainer = document.querySelector(
        ".weblyne-canvas-container",
      );
      if (
        !canvasContainer.contains(e.target) &&
        weblyneContainer.matches(":focus")
      ) {
        weblyneContainer.blur();
      }
    });

    const canvas = document.getElementById("canvas");
    const statusElement = document.getElementById("status");
    const progressElement = document.getElementById("progress");
    const verifyButton = document.getElementById("verify-button");
    const weblyneContainer = document.querySelector(".weblyne-container");
    const refreshButton = document.getElementById("refresh-button");
    const backButton = document.getElementById("back-button");
    let isDebugActive = false;
    let enemiesKilled = 0;

    function restartGame() {
      enemiesKilled = 0;
      updateVerifyButton();

      // Track game start
      va("event", { name: "game_start" });

      // Call the native DOOM restart function directly
      Module["_G_DoReborn"]();
    }

    function updateVerifyButton() {
      const verifySpan = verifyButton.querySelector("span");
      verifySpan.textContent = `${enemiesKilled}/5`;
      verifyButton.setAttribute(
        "aria-label",
        `Verify, ${enemiesKilled} out of 5 monsters killed`,
      );

      if (enemiesKilled >= 5) {
        verifyButton.style.backgroundColor = "#212529";
        verifyButton.style.color = "white";
        verifyButton.style.cursor = "pointer";
      } else {
        verifyButton.style.backgroundColor = "#f0f0f0";
        verifyButton.style.color = "#888";
        verifyButton.style.cursor = "default";
      }
    }

    // prevent losing focus when it's tapped
    refreshButton.addEventListener("mousedown", (e) => {
      e.preventDefault();
    });

    refreshButton.addEventListener("click", (e) => {
      e.preventDefault();
      weblyneContainer.focus();
      restartGame();
    });


    // prevent losing focus when it's tapped
    backButton.addEventListener("mousedown", (e) => {
      e.preventDefault();
    });

    backButton.addEventListener("click", (e) => {
      e.preventDefault();
      location.href = 'https://voltarius.voltaccept.com';
    });

    function showSuccess() {

      // Track successful solve
      va("event", { name: "weblyne_solved", data: { kills: enemiesKilled } });

      // Pause the game
      Module.pauseMainLoop();

      // Hide the weblyne container completely
      weblyneContainer.style.display = "none";

      // Show success message outside the container
      const successDiv = document.createElement("div");
      successDiv.className = "success-message";
      successDiv.style.display = "block";
      successDiv.innerHTML = `
        <h2>weblyne solved!</h2>
        <a href="https://voltarius.voltaccept.com">Go Back ↩</a>
      `;
      document.body.appendChild(successDiv);

      // Lazy load and trigger confetti
      const script = document.createElement("script");
      script.src =
        "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
      script.onload = () => {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
        });
      };
      script.onerror = () => {

      };
      document.body.appendChild(script);
    }

    weblyneContainer.addEventListener("focus", () => {
      va("event", { name: "game_resume" });
      Module.resumeMainLoop();
    });

    weblyneContainer.addEventListener("blur", () => {
      va("event", { name: "game_pause" });
      Module.pauseMainLoop();
    });

    // Mobile controls handling
    const mobileControls = {
      up: { keyCode: 38 }, // Arrow Up
      down: { keyCode: 40 }, // Arrow Down
      left: { keyCode: 37 }, // Arrow Left
      right: { keyCode: 39 }, // Arrow Right
      fire: { keyCode: 32 }, // Space
    };

    function ensureGameFocused() {
      if (!weblyneContainer.matches(":focus")) {
        weblyneContainer.focus();
      }
    }

    function simulateKeyEvent(type, keyCode) {
      const event = new KeyboardEvent(type, {
        keyCode: keyCode,
        bubbles: true,
        cancelable: true,
      });
      weblyneContainer.dispatchEvent(event);
    }

    function handleTouchStart(key) {
      return (e) => {
        e.preventDefault();
        ensureGameFocused();
        simulateKeyEvent("keydown", mobileControls[key].keyCode);
      };
    }

    function handleTouchEnd(key) {
      return (e) => {
        e.preventDefault();
        ensureGameFocused();
        simulateKeyEvent("keyup", mobileControls[key].keyCode);
      };
    }

    // Ensure controls are clickable even when game is not focused
    document.querySelector(".mobile-controls").addEventListener(
      "touchstart",
      (e) => {
        ensureGameFocused();
      },
      { passive: false },
    );

    // Setup touch controls
    document
      .querySelectorAll(".d-pad button, .fire-button")
      .forEach((button) => {
        let key = button.className.split(" ")[0];
        if (!key || key === "fire-button") key = "fire";

        button.addEventListener("touchstart", handleTouchStart(key));
        button.addEventListener("touchend", handleTouchEnd(key));
        button.addEventListener("touchcancel", handleTouchEnd(key));
      });

    var Module = {
      keyboardListeningElement: weblyneContainer,
      arguments: [
        "-autoreborn",
        "-nomenu",
        "-skill",
        "1",
        "-warp",
        "1",
        "1",
      ],
      preRun: [
        function () {
          SDL.defaults.copyOnLock = false;

          // Store the original lookupKeyCodeForEvent function
          const originalLookupKeyCodeForEvent = SDL.lookupKeyCodeForEvent;

          // Create a wrapper that modifies key behavior
          SDL.lookupKeyCodeForEvent = function (event) {
            // Ignore Escape key by returning 0
            if (event.keyCode === 27) {
              weblyneContainer.blur();
              return 0;
            }

            // Ignore Ctrl key by returning 0
            if (event.keyCode === 17) {
              return originalLookupKeyCodeForEvent({ ...event, keyCode: 32 });
            }

            // Treat Spacebar (keyCode 32) as Ctrl
            if (event.keyCode === 32) {
              return originalLookupKeyCodeForEvent({ ...event, keyCode: 17 });
            }

            // For all other keys, use the original function
            return originalLookupKeyCodeForEvent(event);
          };
        },
      ],
      postRun: [],
      onPlayerBorn: function () {
        document
          .querySelector(".status-message.death")
          .classList.remove("visible");
      },
      onPlayerDeath: function () {
        va("event", { name: "player_death", data: { kills: enemiesKilled } });
        enemiesKilled = 0;
        updateVerifyButton();
        document
          .querySelector(".status-message.death")
          .classList.add("visible");
      },
      onEnemyKilled: function () {
        enemiesKilled++;
        va("event", { name: "enemy_killed", data: { kills: enemiesKilled } });
        updateVerifyButton();

        // Get the icon path
        const iconPath = verifyButton.querySelector(
          ".weblyne-verify-icon path",
        );

        // Reset animations
        verifyButton.style.animation = "none";
        iconPath.style.animation = "none";
        verifyButton.offsetHeight; // Trigger reflow

        // Set end colors based on kill count
        const isComplete = enemiesKilled >= 5;
        verifyButton.style.setProperty(
          "--end-color",
          isComplete ? "#212529" : "#f0f0f0",
        );
        iconPath.style.setProperty(
          "--end-icon-color",
          isComplete ? "white" : "#888888",
        );

        // Trigger animations
        verifyButton.style.animation = "killFlash 0.5s ease forwards";
        iconPath.style.animation = "iconFlash 0.5s ease forwards";

        // Show success message when 5 enemies are killed
        if (enemiesKilled === 5) {
          showSuccess();
        }
      },
      print: function (text) {
        if (arguments.length > 1)
          text = Array.prototype.slice.call(arguments).join(" ");
        console.log(text);
      },
      printErr: function (text) {
        if (arguments.length > 1)
          text = Array.prototype.slice.call(arguments).join(" ");
        console.error(text);
      },
      canvas: canvas,
      setStatus: function (text) {
        if (!Module.setStatus.last)
          Module.setStatus.last = { time: Date.now(), text: "" };
        if (text === Module.setStatus.last.text) return;
        const m = text.match(/([^(]+)$$(\d+(\.\d+)?)\/(\d+)$$/);
        const now = Date.now();
        if (m && now - Module.setStatus.last.time < 30) return;
        Module.setStatus.last.time = now;
        Module.setStatus.last.time = now;
        Module.setStatus.last.text = text;
        if (m) {
          text = m[1];
          progressElement.value = parseInt(m[2]) * 100;
          progressElement.max = parseInt(m[4]) * 100;
          progressElement.hidden = false;
        } else {
          progressElement.value = null;
          progressElement.max = null;
          progressElement.hidden = true;
        }
        statusElement.innerHTML = text;
      },
      totalDependencies: 0,
      monitorRunDependencies: function (left) {
        this.totalDependencies = Math.max(this.totalDependencies, left);
        Module.setStatus(
          left
            ? "Preparing... (" +
            (this.totalDependencies - left) +
            "/" +
            this.totalDependencies +
            ")"
            : "All downloads complete.",
        );
      },
    };
    Module.setStatus("Downloading ...");
    window.onerror = function () {
      Module.setStatus("Exception thrown, see JavaScript console");
      Module.setStatus = function (text) {
        if (text) Module.printErr("[post-exception status] " + text);
      };
    };
  </script>
  {{{ SCRIPT }}}
</body>

</html>