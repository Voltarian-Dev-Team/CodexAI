<!DOCTYPE html>
<html lang="en">

<head>
    <title>CodexAI</title>
    <meta name="author" content="VoltacceptYT">
    <meta name="keywords" content="CodexAI, AI Assistant, Google Gemini, Chatbot, AI, Assistant, ChatGPT, Gemini 2.0">
    <meta name="description" content="CodexAI - Your AI Assistant powered by Google Gemini.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">

    <link rel="icon" href="./assets/img/CodexAI.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Apply the theme early to prevent flickering
        const currentTheme = localStorage.getItem('theme') || 'dark';
        document.write(`<link id="theme-link" rel="stylesheet" href="./assets/css/${currentTheme}-theme.css">`);
    </script>
</head>

<body>
    <div id="chat-container">
        <div id="chat-box">
            <div id="messages"></div>
        </div>
        <form id="chat-form">
            <textarea type="text" id="user-input" placeholder="Type your message here..." required
                style="white-space: pre-wrap;"></textarea>
            <button type="submit">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                    <path
                        d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z" />
                </svg>
            </button>
            <div class="form-btn-container">
                <button type="button" id="start-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                        <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0z" />
                        <path
                            d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5" />
                    </svg>
                </button>
                <button type="button" id="clear-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                        <path
                            d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0" />
                    </svg>
                </button>
                <button type="button" id="theme-toggle-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path
                            d="M10,2c-4.41,0-8,3.59-8,8s3.59,8,8,8c1.1,0,2-0.9,2-2c0-0.49-0.18-0.96-0.51-1.34c-0.06-0.08-0.1-0.17-0.1-0.26 c0-0.22,0.18-0.4,0.4-0.4h1.42c2.65,0,4.8-2.15,4.8-4.8C18,5.23,14.41,2,10,2z M5.5,10.75c-0.69,0-1.25-0.56-1.25-1.25 c0-0.69,0.56-1.25,1.25-1.25S6.75,8.81,6.75,9.5C6.75,10.19,6.19,10.75,5.5,10.75z M8,7.75c-0.69,0-1.25-0.56-1.25-1.25 c0-0.69,0.56-1.25,1.25-1.25S9.25,5.81,9.25,6.5C9.25,7.19,8.69,7.75,8,7.75z M12,7.75c-0.69,0-1.25-0.56-1.25-1.25 c0-0.69,0.56-1.25,1.25-1.25s1.25,0.56,1.25,1.25C13.25,7.19,12.69,7.75,12,7.75z M14.5,10.75c-0.69,0-1.25-0.56-1.25-1.25 c0-0.69,0.56-1.25,1.25-1.25s1.25,0.56,1.25,1.25C15.75,10.19,15.19,10.75,14.5,10.75z" />
                    </svg>
                </button>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let themeLink = document.getElementById('theme-link');
        let recognition;

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => console.log('Speech Recognition: START');
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Recognized:', transcript);
                if (transcript) {
                    addMessage(transcript, "user");
                    fetchGeminiResponse(transcript);
                }
            };
            recognition.onerror = (event) => console.error('Speech Recognition Error:', event.error);
            recognition.onend = () => console.log('Speech Recognition: END');

            document.getElementById('start-btn').addEventListener('click', () => recognition.start());
        } else {
            alert('Your browser does not support the Web Speech API');
        }

        function handleGoogleLoginResponse(response) {
            const credential = JSON.parse(atob(response.credential.split('.')[1]));
            const userName = credential.name;
            const userPicture = credential.picture; // Fetch the user's Google profile picture
            localStorage.setItem('displayName', userName);
            localStorage.setItem('profilePicture', userPicture); // Save profile picture to localStorage
            window.location.reload();
        }

        function getOperatorProfilePicture() {
            return localStorage.getItem('profilePicture') || './assets/img/user-profile.png';
        }

        // Check if the user is logged in
        function checkLoginStatus() {
            const displayName = localStorage.getItem('displayName');
            if (displayName) {
                // Remove Google Sign-In elements if the user is logged in
                const googleOnloadElement = document.getElementById('g_id_onload');
                if (googleOnloadElement) {
                    googleOnloadElement.remove();
                }
            }
        }

        // Run the login status check on page load
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        // Load chat history from localStorage
        if (chatHistory.length > 0) {
            chatHistory.forEach((message) => {
                addMessage(message.text, message.role);
            });

            const ChatBox = document.getElementById("chat-box");
            ChatBox.scrollTop = ChatBox.scrollHeight;
        }

        document.getElementById("chat-form").addEventListener("submit", function (event) {
            event.preventDefault();
            const userInput = document.getElementById("user-input").value;
            addMessage(userInput, "user");
            fetchGeminiResponse(userInput);
            document.getElementById("user-input").value = "";
        });

        document.getElementById("user-input").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                if (event.shiftKey) {
                    const cursorPosition = this.selectionStart;
                    const value = this.value;
                    this.value = value.slice(0, cursorPosition) + "\n" + value.slice(cursorPosition);
                    this.selectionEnd = cursorPosition + 1;
                    event.preventDefault();
                } else {
                    event.preventDefault();
                    document.getElementById("chat-form").dispatchEvent(new Event("submit"));
                }
            }
        });

        function setTheme(theme) {
            themeLink.href = `./assets/css/${theme}-theme.css`;
            localStorage.setItem('theme', theme);
        }

        setTheme(currentTheme);

        function addMessage(message, sender) {
            const messages = document.getElementById("messages");

            const profile = document.createElement('div');
            profile.classList.add('profile', `${sender}-profile`);

            const messageElement = document.createElement("div");
            messageElement.classList.add("message", `${sender}-message`);

            if (sender === "assistant") {
                const formattedMessage = marked.parse(message);
                messageElement.innerHTML = formattedMessage;
            } else {
                const userText = message.replace(/\n/g, '<br>');
                messageElement.innerHTML = marked.parse(userText);
            }

            if (sender === "user") {
                profile.innerHTML = `<img src="${getOperatorProfilePicture()}" alt="User Profile Picture" class="profile-picture"><p class="name">${getOperatorName()}</p>`;
                messages.appendChild(profile);
                messages.appendChild(messageElement);
            } else if (sender === "assistant") {
                profile.innerHTML = `<img src="./assets/img/ai-profile.png" alt="AI Profile Picture" class="profile-picture"><p class="name">CodexAI</p>`;
                messages.appendChild(profile);
                messages.appendChild(messageElement);
            }

            chatHistory.push({ role: sender === "user" ? "user" : "assistant", text: message });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        async function fetchGeminiResponse(message) {
            console.log(`Sending message to API: ${message}`);

            const base64ApiKey = "QUl6YVN5Q2dhZkNLcFFUTVBjeWxKSUdjLXNBd0l4XzVJVkxuZDNz";
            const apiKey = atob(base64ApiKey);
            const data = {
                contents: chatHistory.map(msg => ({ role: msg.role, parts: [{ text: msg.text }] })),
                systemInstruction: {
                    role: "assistant",
                    parts: [
                        {
                            text: `You are CodexAI, an AI assistant based on Google Gemini. You are designed to provide helpful and informative responses. Be clear, concise, and avoid unnecessary details. When asked about code, provide well-formatted and well-explained examples. If additional information or context is needed, you may use Google search to assist you. The user's name is ${getOperatorName()}.`,
                        }
                    ]
                },
                generationConfig: {
                    temperature: 1,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                    responseMimeType: "text/plain"
                },
                tools: [
                    {
                        google_search: {}
                    }
                ]
            };

            const headers = new Headers();
            headers.append("Content-Type", "application/json");

            try {
                const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + apiKey, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorResponse = await response.json();
                    console.error('API Request Failed:', errorResponse);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log(result);

                if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0]) {
                    const botMessage = result.candidates[0].content.parts[0].text.trim();
                    addMessage(botMessage, "assistant");
                } else {
                    addMessage("I'm sorry, I am currently unable to process your request.", "assistant");
                }
            } catch (error) {
                console.error("Error:", error);
                addMessage("I'm sorry, I am currently unable to process your request.", "assistant");
            }
        }

        function getOperatorName() {
            return localStorage.getItem('displayName') || 'Guest';
        }

        document.getElementById('theme-toggle-btn').addEventListener('click', () => {
            const newTheme = themeLink.href.includes('dark-theme.css') ? 'light' : 'dark';
            setTheme(newTheme);
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            localStorage.removeItem('chatHistory');
            window.location.reload();
        });
    </script>
</body>

</html>